<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Main Page</title>
    <link href="/styles.css" rel="stylesheet" type="text/ss"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script> 
      $(document).ready(function(){
        $.fn.printOnTable = function(emp, hash){
          var content = '<tr data-href="https://www.blockchain.com/btc/tx/'+hash+'">';
          for(var i = emp.length - 1; i >= 0; i--){
            content += ('<td>' + emp[i] + '</td>');
          }
          content += '</tr>';
          $('#transactions').append(content);
        }
        $('#getAllButton').click(function(){
          $.ajax({
            url: 'transactions/',
            type: 'GET',
            dataType: 'json',
            success: (data) => {
              data.sort((a,b) => b.amount_usd - a.amount_usd);
              // # of transactions, repeats 4 times
              for(key in data){
                var emp = [];
                var hash = '';
                var datakey = data[key];
                for(obj in datakey){
                  if(obj =='amount'){
                    //console.log(datakey.amount);
                    //$.fn.printOnTable(datakey.amount);
                    emp.push(datakey.amount);
                  }
                  if(obj =='amount_usd'){
                    //console.log(datakey.amount_usd);
                    //$.fn.printOnTable(datakey.amount_usd);
                    emp.push(datakey.amount_usd);
                  }
                  if(obj =='id'){
                    //console.log(datakey.id);
                    emp.push(datakey.id);
                  }
                  if(obj =='from'){
                    var ob = datakey[obj];
                    for(var j in ob){
                      //console.log('f'+ob.owner);
                      emp.push(ob.owner);
                      break;
                    }
                  }
                  if(obj =='to'){
                    var ob = datakey[obj];
                    for(var j in ob){
                      //console.log('t'+ob.owner);
                      emp.push(ob.owner);
                      break;
                    }
                  }
                  if(obj =='timestamp'){
                    //console.log(datakey.timestamp);
                    emp.push(datakey.timestamp);
                  }
                  if(obj =='hash'){
                    hash = datakey.hash;
                  }
                }
                //prints array [id, from, to, timestamp, amount, amount_usd]
                //console.log(emp);
                $.fn.printOnTable(emp, hash);
              }
              
              const rows = document.querySelectorAll("tr[data-href]");
              rows.forEach(row => {
                row.addEventListener('click', () => {
                  window.location.href = row.dataset.href;
                });
              });
              
              //emp += JSON.stringify(data[key].amount);
              emp += JSON.stringify(data);
              $('#status').html();
            }
          })
        })
    });
    </script>
    <style>
    table{
      border-collapse: collapse;
      width: 100%;
      }

      th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      tr:hover {background-color:#f5f5f5;}

      tr[data-href]{
        cursor: pointer;
      }
</style>
  </head>
  <body>
    {{ message }}
    <button id='getAllButton'>Get all transactions</button>
    <div id='status'></div>
    <table id="transactions">
      <tr>
        <th>USD Amount</th>
        <th>BTC Amount</th>
        <th>Transaction ID</th>
        <th>To</th>
        <th>From</th>
        <th>UTC Time</th>
      </tr>
    </table>
  </body>
</html>